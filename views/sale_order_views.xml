<odoo>
    <record id="view_order_form_inherit" model="ir.ui.view">
        <field name="name">sale.order.form.inherit</field>
        <field name="model">sale.order</field>
        <field name="priority" eval="200"/>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <!-- Add horizontal subscription progress bar in sheet -->
            <xpath expr="//form[1]/sheet[1]/group[1]" position="before">
                <div class="oe_title" style="margin-bottom: 20px;" invisible="not subscription_state">
                    <field name="subscription_state" invisible="1"/>
                    <field name="progress_stage" invisible="1"/>
                    <div style="margin-top: 15px; padding: 15px; background-color: #f5f5f5; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <!-- Draft Stage - Clickable -->
                            <button name="action_quotation_send" type="object" 
                                    style="text-align: center; flex: 1; border: none; background: none; cursor: pointer; padding: 10px;"
                                    invisible="progress_stage != 'draft'">
                                <i class="fa fa-file-text-o fa-2x" style="color: #5cb85c;"/><br/>
                                <small style="font-weight: bold;">Draft<br/>(Click to Send Quote)</small>
                            </button>
                            <div style="text-align: center; flex: 1;" invisible="progress_stage == 'draft'">
                                <i class="fa fa-file-text-o fa-2x" style="color: #999;"/><br/>
                                <small>Draft</small>
                            </div>
                            
                            <div style="flex: 0; padding: 0 5px;">→</div>
                            
                            <!-- Confirmed Stage - Not clickable -->
                            <div style="text-align: center; flex: 1;" invisible="progress_stage != 'confirmed'">
                                <i class="fa fa-check-circle fa-2x" style="color: #5cb85c;"/><br/>
                                <small style="font-weight: bold;">Confirmed</small>
                            </div>
                            <div style="text-align: center; flex: 1;" invisible="progress_stage == 'confirmed'">
                                <i class="fa fa-check-circle fa-2x" style="color: #999;"/><br/>
                                <small>Confirmed</small>
                            </div>
                            
                            <div style="flex: 0; padding: 0 5px;">→</div>
                            
                            <!-- Contract Stage - Clickable -->
                            <button name="action_send_contract" type="object" 
                                    style="text-align: center; flex: 1; border: none; background: none; cursor: pointer; padding: 10px;"
                                    invisible="progress_stage != 'pending_contract'">
                                <i class="fa fa-file-text fa-2x" style="color: #5cb85c;"/><br/>
                                <small style="font-weight: bold;">Contract<br/>(Click to Send)</small>
                            </button>
                            <div style="text-align: center; flex: 1;" invisible="progress_stage == 'pending_contract'">
                                <i class="fa fa-file-text fa-2x" style="color: #999;"/><br/>
                                <small>Contract</small>
                            </div>
                            
                            <div style="flex: 0; padding: 0 5px;">→</div>
                            
                            <!-- Pending Client Sign Stage - Not clickable (waiting for customer) -->
                            <div style="text-align: center; flex: 1;" invisible="progress_stage != 'pending_client_signature'">
                                <i class="fa fa-pencil-square-o fa-2x" style="color: #5cb85c;"/><br/>
                                <small style="font-weight: bold;">Pending Sign</small>
                            </div>
                            <div style="text-align: center; flex: 1;" invisible="progress_stage == 'pending_client_signature'">
                                <i class="fa fa-pencil-square-o fa-2x" style="color: #999;"/><br/>
                                <small>Pending Sign</small>
                            </div>
                            
                            <div style="flex: 0; padding: 0 5px;">→</div>
                            
                            <!-- Cabal Sign Stage - Not clickable (internal signing) -->
                            <div style="text-align: center; flex: 1;" invisible="progress_stage != 'pending_cabal_signature'">
                                <img src="/contract_management/static/description/cabal.ico" style="width: 32px; height: 32px; filter: brightness(0) saturate(100%) invert(64%) sepia(98%) saturate(359%) hue-rotate(72deg) brightness(91%) contrast(87%);"/><br/>
                                <small style="font-weight: bold;">Cabal Sign</small>
                            </div>
                            <div style="text-align: center; flex: 1;" invisible="progress_stage == 'pending_cabal_signature'">
                                <img src="/contract_management/static/description/cabal.ico" style="width: 32px; height: 32px; opacity: 0.4;"/><br/>
                                <small>Cabal Sign</small>
                            </div>
                            
                            <div style="flex: 0; padding: 0 5px;">→</div>
                            
                            <!-- Schedule Install Stage - Clickable button when 1b_schedule, grey fallback otherwise -->
                            <button name="action_schedule_install_task" type="object" 
                                    style="text-align: center; flex: 1; border: none; background: none; cursor: pointer; padding: 10px;"
                                    invisible="progress_stage != 'schedule_install'">
                                <i class="fa fa-calendar fa-2x" style="color: #5cb85c;"/><br/>
                                <small style="font-weight: bold;">Schedule Install<br/>(Click to Open Task)</small>
                            </button>
                            <div style="text-align: center; flex: 1;" invisible="progress_stage == 'schedule_install'">
                                <i class="fa fa-calendar fa-2x" style="color: #999;"/><br/>
                                <small>Schedule Install</small>
                            </div>
                            
                            <div style="flex: 0; padding: 0 5px;">→</div>
                            
                            <!-- Install Stage - Green when 1b_install, grey otherwise -->
                            <div style="text-align: center; flex: 1;" invisible="progress_stage != 'pending_install'">
                                <i class="fa fa-wrench fa-2x" style="color: #5cb85c;"/><br/>
                                <small style="font-weight: bold;">Pending Install</small>
                            </div>
                            <div style="text-align: center; flex: 1;" invisible="progress_stage == 'pending_install'">
                                <i class="fa fa-wrench fa-2x" style="color: #999;"/><br/>
                                <small>Pending Install</small>
                            </div>
                            
                            <div style="flex: 0; padding: 0 5px;">→</div>
                            
                            <!-- Final Stage - Active/Paused/Suspended/Churned -->
                            <!-- Active (3_progress, 4_paused, 5_renewed) -->
                            <div style="text-align: center; flex: 1;" invisible="progress_stage != 'active'">
                                <i class="fa fa-play-circle fa-2x" style="color: #5cb85c;" title="Active"/><br/>
                                <small style="font-weight: bold;">Active</small>
                            </div>
                            <!-- Paused (4_paused) - Clickable -->
                            <button name="action_reactivate_subscription_wizard" type="object" 
                                    style="text-align: center; flex: 1; border: none; background: none; cursor: pointer; padding: 10px;"
                                    invisible="progress_stage != 'paused'">
                                <i class="fa fa-pause-circle fa-2x" style="color: #f0ad4e;"/><br/>
                                <small style="font-weight: bold; color: #f0ad4e;">Paused<br/>(Click to Reactivate)</small>
                            </button>
                            <!-- Suspended (8_suspend) -->
                            <div style="text-align: center; flex: 1;" invisible="progress_stage != 'suspended'">
                                <i class="fa fa-ban fa-2x" style="color: #d9534f;"/><br/>
                                <small style="font-weight: bold; color: #d9534f;">Suspended</small>
                            </div>
                            <!-- Churned (6_churn) -->
                            <div style="text-align: center; flex: 1;" invisible="progress_stage != 'churned'">
                                <i class="fa fa-times-circle fa-2x" style="color: #777;"/><br/>
                                <small style="font-weight: bold; color: #777;">Churned</small>
                            </div>
                            <!-- Default grey state for Active/Paused/Suspended/Churned when none match -->
                            <div style="text-align: center; flex: 1;" invisible="progress_stage == 'active' or progress_stage == 'paused' or progress_stage == 'suspended' or progress_stage == 'churned'">
                                <i class="fa fa-play-circle fa-2x" style="color: #999;" title="Active"/><br/>
                                <small>Active</small>
                            </div>
                        </div>
                    </div>
                </div>
            </xpath>

            <xpath expr="//field[@name='client_order_ref']" position="after">
                <field name="renewal_of_id" readonly="1" options="{'no_open': True}"/>
                <field name="upsell_from_id" readonly="1" options="{'no_open': True}"/>
            </xpath>
            
            <!-- Add smart buttons for contracts -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" type="object" name="action_view_contracts"
                        icon="fa-briefcase" invisible="contract_count == 0">
                    <field string="Contracts" name="contract_count" widget="statinfo"/>
                </button>
                <!-- FSM smart button commented out until FSM modules installed in test env
                <button class="oe_stat_button" type="object" name="action_view_fsm_tasks"
                        icon="fa-wrench" invisible="fsm_task_count == 0">
                    <field string="Install Tasks" name="fsm_task_count" widget="statinfo"/>
                </button>
                -->
            </xpath>
            
            <xpath expr="//form[1]/header[1]/button[@name='action_confirm'][2]" position="attributes">
                <attribute name="invisible">subscription_state != '1c_nocontract'</attribute>
            </xpath>
            <xpath expr="//form[1]/header[1]/button[@name='action_quotation_send']" position="attributes">
                <attribute name="invisible">subscription_state != '1_draft'</attribute>
            </xpath>
            <xpath expr="//form[1]/header[1]/button[@name='action_draft']" position="attributes">
                <attribute name="invisible">subscription_state != '1_draft'</attribute>
            </xpath>
            <xpath expr="//form[1]/header[1]/button[@name='action_quotation_send'][3]" position="replace"/>
            <xpath expr="//form[1]/header[1]/button[@name='action_quotation_send'][2]" position="replace"/>
            <xpath expr="//form[1]/header[1]" position="inside">
                <field name="can_resend_contract" invisible="1"/>
                <field name="docusign_connector_ids" invisible="1"/>
                <!-- <field name="next_action" invisible="1"/> FSM field - commented out until FSM modules installed -->
                <button string="Send Contract" type="object" name="action_send_contract"
                        class="btn-primary" icon="fa-file-signature"
                        invisible="subscription_state != '1c_nocontract' or docusign_connector_ids"/>
                <button string="Resend Contract" type="object" name="action_resend_contract"
                        class="btn-secondary" icon="fa-refresh"
                        invisible = "not can_resend_contract"/>
                
                <!-- Dynamic Next Action button - Commented out until FSM modules installed in test env
                <button string="Create Install Task" type="object" name="action_next_step"
                        class="btn-primary" icon="fa-calendar-plus"
                        invisible="next_action != 'create_task'"/>
                <button string="Schedule Install" type="object" name="action_next_step"
                        class="btn-primary" icon="fa-calendar-check"
                        invisible="next_action != 'schedule_task'"/>
                <button string="Activate Service" type="object" name="action_next_step"
                        class="btn-primary" icon="fa-power-off"
                        invisible="next_action != 'activate_service'"/>
                -->
            </xpath>
<!--            <xpath expr="//form[1]/header[1]/button[@name='activate_onu']" position="attributes">
                <attribute name="invisible">subscription_state not in ["1b_install", "1d_internal"]</attribute>
            </xpath>
            <xpath expr="//form[1]/header[1]/button[@name='action_get_signature']" position="attributes">
                <attribute name="invisible">True</attribute>
            </xpath>
-->            
            <!-- Suppress subscription_state badge from base sale.order view -->
            <xpath expr="//form[1]/sheet[1]/field[@name='subscription_state'][2]" position="attributes">
                <attribute name="invisible">True</attribute>
            </xpath>
            
            <!-- Make order lines readonly when not in draft stage -->
            <xpath expr="//field[@name='order_line']" position="attributes">
                <attribute name="readonly">progress_stage != 'draft'</attribute>
            </xpath>
            
            <xpath expr="//form[1]/sheet[1]/notebook[1]" position="inside">
                <page string="Terms/Conditions" name="terms_conditions">
                <group name="tc_group_2ca">
                    <field name="cover_letter_id" readonly="1"/>
                    <field name="terms_conditions_ids" widget="many2many_tags"/>
                    <field name="clause_ids"/>
                </group>
                </page>
            </xpath>
        </field>
    </record>
</odoo>